---
tags:
  - diary
---
new> [!IMPORTANT]
> 雑な思いつきを書いていこう
> 終わったらChatGPTに突っ込んだりして企画書整形しよう



- 03:16
	タグでpjt/〇〇とつけると、03_project下の〇〇に移動できる仕組みを作りました。
	ctrl+Pでコマンドパレット読んで、project tag moverを起動すると整理します


- 06:57 寝るのだ。ハードコミットしんどかったのだ。

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const { Plugin, Notice, parseYaml, PluginSettingTab, Setting, TFile } = require("obsidian");

/* ---------- デフォルト設定 ---------- */
const DEFAULT_SETTINGS = {
  tagPrefix: "#pjt/",
  rootFolder: "03_project"
};

/* ---------- プラグイン本体 ---------- */
class ProjectTagMover extends Plugin {
  async onload() {
    console.log("ProjectTagMover loading…");
    await this.loadSettings();
    this.addSettingTab(new ProjectTagMoverSettingTab(this.app, this));

    // 単一ノート移動コマンド
    this.addCommand({
      id: "move-note-by-tag",
      name: "Move Current Note by Tag",
      callback: async () => await this.moveActiveFile()
    });

    // プロジェクト全体移動コマンド
    this.addCommand({
      id: "move-project-by-tag",
      name: "Move All Notes in Project by Tag",
      callback: async () => await this.moveProjectFiles()
    });
  }

  // 単一ノート処理
  async moveActiveFile() {
    const file = this.app.workspace.getActiveFile();
    if (!(file instanceof TFile) || !file.path.endsWith(".md")) {
      new Notice("アクティブなMarkdownファイルを開いてください。");
      return;
    }
    const tag = await this.extractProjectTag(file);
    if (!tag) return;
    await this.moveFileToProject(file, tag);
  }

  // プロジェクト全体処理
  async moveProjectFiles() {
    const active = this.app.workspace.getActiveFile();
    if (!(active instanceof TFile)) {
      new Notice("アクティブなMarkdownファイルを開いてください。");
      return;
    }
    const projectTag = await this.extractProjectTag(active);
    if (!projectTag) return;
    const rootSegment = projectTag.split("/")[0];
    const files = this.app.vault.getMarkdownFiles();
    let movedCount = 0;
    for (const file of files) {
      const tag = await this.extractProjectTag(file);
      if (tag && tag.startsWith(rootSegment)) {
        await this.moveFileToProject(file, tag);
        movedCount++;
      }
    }
    new Notice(`Moved ${movedCount} file(s) in project '${rootSegment}'`);
  }

  // タグ抽出共通
  async extractProjectTag(file) {
    let content;
    try {
      content = await this.app.vault.read(file);
    } catch (e) {
      console.error("ファイル読み込み失敗:", e);
      return null;
    }
    const tags = [];
    const fmMatch = content.match(/^---\s*\n([\s\S]*?)\n---/);
    if (fmMatch) {
      try {
        const fmObj = parseYaml(fmMatch[1]);
        if (fmObj && fmObj.tags) {
          const fmTags = Array.isArray(fmObj.tags) ? fmObj.tags : [fmObj.tags];
          tags.push(...fmTags.map(t => String(t)));
        }
      } catch (e) {
        console.warn("YAML解析失敗:", e);
      }
    }
    const body = fmMatch ? content.slice(fmMatch[0].length) : content;
    const rawPrefix = this.settings.tagPrefix.replace(/^#/, "");
    const prefixEsc = rawPrefix.replace("/", "\\/");
    const regex = new RegExp(`[#]?${prefixEsc}[^\\s#]+`, "g");
    const matches = body.match(regex);
    if (matches) tags.push(...matches);
    const found = tags.find(t => {
      const clean = String(t).replace(/^['"#]+|['"]+$/g, "").replace(/^#/, "");
      return clean.startsWith(rawPrefix);
    });
    if (!found) {
      if (file === this.app.workspace.getActiveFile()) {
        new Notice("対応するプロジェクトタグが見つかりません。");
      }
      return null;
    }
    return found.replace(/^['"#]+|['"]+$/g, "").replace(/^#/, "").substring(rawPrefix.length);
  }

  // ファイル移動
  async moveFileToProject(file, relativePath) {
    const target = `${this.settings.rootFolder}/${relativePath}/${file.name}`;
    const folder = target.substring(0, target.lastIndexOf("/"));
    try {
      if (!(await this.app.vault.adapter.exists(folder))) {
        await this.app.vault.adapter.mkdir(folder);
      }
      await this.app.fileManager.renameFile(file, target);
      console.log(`Moved '${file.path}' → '${target}'`);
    } catch (e) {
      console.error("移動失敗:", e);
      new Notice("ファイル移動に失敗しました。");
    }
  }

  onunload() {
    console.log("ProjectTagMover unloaded.");
  }

  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }
  async saveSettings() {
    await this.saveData(this.settings);
  }
}
exports.default = ProjectTagMover;

/* ---------- 設定画面 ---------- */
class ProjectTagMoverSettingTab extends PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }

  display() {
    const { containerEl } = this;
    containerEl.empty();
    containerEl.createEl("h2", { text: "Project Tag Mover Settings" });

    new Setting(containerEl)
      .setName("Tag Prefix")
      .setDesc("タグ判定に使う接頭辞（例 #pjt/）")
      .addText(text =>
        text
          .setPlaceholder("#pjt/")
          .setValue(this.plugin.settings.tagPrefix)
          .onChange(async v => {
            this.plugin.settings.tagPrefix = v.trim();
            await this.plugin.saveSettings();
          })
      );

    new Setting(containerEl)
      .setName("Root Folder")
      .setDesc("移動先の親フォルダ（例 03_project）")
      .addText(text =>
        text
          .setPlaceholder("03_project")
          .setValue(this.plugin.settings.rootFolder)
          .onChange(async v => {
            this.plugin.settings.rootFolder = v.trim();
            await this.plugin.saveSettings();
          })
      );
  }
}
